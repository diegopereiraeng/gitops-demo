pipeline:
  name: ECS Banking Demo
  identifier: ECS_Banking_Demo
  projectIdentifier: GIT_FLOW_DEMO
  orgIdentifier: default
  tags: {}
  properties:
    ci:
      codebase:
        connectorRef: account.diegogithubapp
        repoName: gitflow-ff-demo
        build: <+input>
  stages:
    - stage:
        name: Build Test Push Dev
        identifier: Build_Container_and_Push
        type: CI
        spec:
          cloneCodebase: true
          serviceDependencies:
            - identifier: dind
              name: dind
              type: Service
              spec:
                connectorRef: account.DockerHubDiego
                image: docker:dind
                privileged: true
                entrypoint:
                  - dockerd-entrypoint.sh
          execution:
            steps:
              - step:
                  type: RestoreCacheGCS
                  name: Restore GCS
                  identifier: Restore_GCS
                  spec:
                    connectorRef: account.SalesGCP
                    bucket: latam-cie-cache
                    key: NodeSonar
                    archiveFormat: Tar
                  when:
                    stageStatus: Success
                  failureStrategies: []
              - parallel:
                  - step:
                      type: Security
                      name: Sonar Scan Vulnerabilities
                      identifier: Sonar_Scan_Vulnerabilities
                      spec:
                        privileged: true
                        settings:
                          policy_type: manualUpload
                          scan_type: repository
                          repository_branch: <+pipeline.variables.branch>
                          product_name: sonarqube
                          product_access_token: sqa_e8b9ccf4a21f914cc88a81ed3cf80b345ed9ff16
                          product_project_name: gitflow-demo
                          product_project_key: gitflow-demo
                          product_domain: http://sonar.harness-demo.site
                          product_config_name: sonarqube-agent
                          product_lookup_type: byKey
                          repository_project: gitflow-ff-demo
                          customer_artifacts_path: /harness/tests/scan_tools/sonarqube/test_data
                          manual_upload_filename: "001"
                        imagePullPolicy: Always
                      when:
                        stageStatus: Success
                      failureStrategies:
                        - onFailure:
                            errors:
                              - AllErrors
                            action:
                              type: Ignore
                  - step:
                      type: Security
                      name: Fortify
                      identifier: fortify
                      spec:
                        connectorRef: account.DockerHubDiego
                        privileged: true
                        settings:
                          product_name: fortify
                          product_config_name: fortify-default
                          policy_type: manualUpload
                          scan_type: repository
                          repository_project: gitflow-ff-demo
                          repository_branch: dev
                          customer_artifacts_path: /harness/tests/fortify
                          manual_upload_filename: "002"
                        imagePullPolicy: Always
                      failureStrategies:
                        - onFailure:
                            errors:
                              - AllErrors
                            action:
                              type: Ignore
                      when:
                        stageStatus: Success
                      timeout: 15m
                  - step:
                      type: Security
                      name: Brakeman Scan
                      identifier: Brakeman_Scan
                      spec:
                        connectorRef: account.DockerHubDiego
                        privileged: true
                        settings:
                          policy_type: manualUpload
                          scan_type: repository
                          repository_project: gitflow-ff-demo
                          repository_branch: <+codebase.branch>
                          product_name: brakeman
                          product_config_name: brakeman-default
                          fail_on_severity: HIGH
                          customer_artifacts_path: /harness/tests/scan_tools/brakeman/test_data
                          manual_upload_filename: "001"
                        imagePullPolicy: Always
                      when:
                        stageStatus: Success
                      failureStrategies:
                        - onFailure:
                            errors:
                              - AllErrors
                            action:
                              type: Ignore
                      timeout: 6m
                  - step:
                      type: Security
                      name: OWASP
                      identifier: OWASP
                      spec:
                        connectorRef: account.DockerHubDiego
                        privileged: true
                        settings:
                          policy_type: manualUpload
                          scan_type: repository
                          repository_project: gitflow-ff-demo
                          repository_branch: <+codebase.branch>
                          product_name: owasp
                          product_config_name: owasp 5.x
                          fail_on_severity: HIGH
                          customer_artifacts_path: /harness/tests/scan_tools/owasp/test_data
                          manual_upload_filename: "001"
                        imagePullPolicy: Always
                      failureStrategies:
                        - onFailure:
                            errors:
                              - AllErrors
                            action:
                              type: Ignore
                      when:
                        stageStatus: Success
                  - step:
                      type: Run
                      name: Lint Check
                      identifier: Lint_Check
                      spec:
                        connectorRef: account.DockerHubDiego
                        image: node:alpine
                        shell: Sh
                        command: |-
                          export NODE_OPTIONS="--max-old-space-size=2048"

                          mkdir -p html/reports/eslint
                          npm install

                          #ls -ltra node_modules/


                          ls html

                          ls html/reports/eslint/

                          npm run lint

                          ls html/reports/eslint/
                        privileged: false
                        reports:
                          type: JUnit
                          spec:
                            paths:
                              - "**/eslint.xml"
                        imagePullPolicy: IfNotPresent
                        resources:
                          limits:
                            memory: 2Gi
                      failureStrategies: []
                  - step:
                      type: Plugin
                      name: SonarQube Quality Gateway Check
                      identifier: SonarQube_Quality_Gateway_Check
                      spec:
                        connectorRef: account.DockerHubDiego
                        image: plugins/sonarqube-scanner:linux-amd64
                        privileged: false
                        reports:
                          type: JUnit
                          spec:
                            paths:
                              - sonarResults.xml
                        settings:
                          sonar_host: http://sonar.harness-demo.site
                          sonar_token: squ_85fe22cb008dc9b5f02104541952792fdf8596d8
                          sources: html
                          binaries: html
                          level: DEBUG
                          sonar_name: gitflow-demo
                          sonar_key: gitflow-demo
                          branch: <+pipeline.variables.branch>
                        imagePullPolicy: Always
                        resources:
                          limits:
                            memory: 2Gi
                      failureStrategies:
                        - onFailure:
                            errors:
                              - AllErrors
                            action:
                              type: Ignore
                      when:
                        stageStatus: Success
              - step:
                  type: Run
                  name: Build Image
                  identifier: Build_Image
                  spec:
                    connectorRef: account.DockerHubDiego
                    image: docker:latest
                    shell: Sh
                    command: |-


                      docker build . -t bankingapp:local --build-arg FFKEY=<+pipeline.variables.ffkey>

                      export tag="ecs-<+pipeline.sequenceId>"
                    outputVariables:
                      - name: tag
              - step:
                  type: Security
                  name: Aqua
                  identifier: Aqua
                  spec:
                    connectorRef: account.DockerHubDiego
                    privileged: true
                    settings:
                      product_name: aqua-trivy
                      product_config_name: aqua-trivy
                      policy_type: manualUpload
                      scan_type: container
                      container_type: local_image
                      container_domain: docker.io
                      container_project: nodegoat
                      container_tag: local
                      fail_on_severity: HIGH
                      customer_artifacts_path: /harness/tests/scan_tools/aqua_trivy/test_data
                      manual_upload_filename: "005"
                    imagePullPolicy: Always
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
                  when:
                    stageStatus: Success
              - parallel:
                  - step:
                      type: BuildAndPushDockerRegistry
                      name: Build Container and Push to Docker Hub
                      identifier: Build_Container_and_Push_to_Docker_Hub
                      spec:
                        connectorRef: account.DockerHubDiego
                        repo: diegokoala/harness-ff-bankingapp-ecs
                        tags:
                          - <+execution.steps.Build_Image.output.outputVariables.tag>
                          - ecs
                        dockerfile: Dockerfile
                        buildArgs:
                          FFKEY: <+pipeline.variables.ffkey>
                        optimize: true
                  - step:
                      type: SaveCacheGCS
                      name: Save GCS
                      identifier: Save_GCS
                      spec:
                        connectorRef: account.SalesGCP
                        bucket: latam-cie-cache
                        key: NodeSonar
                        sourcePaths:
                          - node_modules
                          - .sonar
                        archiveFormat: Tar
                      when:
                        stageStatus: Success
                      failureStrategies: []
          serviceConfig:
            serviceRef: ""
            serviceDefinition:
              type: Kubernetes
              spec:
                variables: []
          sharedPaths:
            - /var/run
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
        when:
          pipelineStatus: Success
        variables:
          - name: sto_api_key
            type: String
            value: <+secrets.getValue("account.sto_api_key")>
    - stage:
        name: Canary Deploy
        identifier: Deploy
        description: ""
        type: Deployment
        spec:
          deploymentType: ECS
          service:
            serviceRef: <+input>
            serviceInputs: <+input>
          environment:
            environmentRef: prod
            deployToAll: false
            infrastructureDefinitions:
              - identifier: ECS_SE_Cluster_Prod
          execution:
            steps:
              - step:
                  type: Container
                  name: BG Color Check
                  identifier: BG_Color_Check
                  spec:
                    connectorRef: account.DockerHubDiego
                    image: amazon/aws-cli
                    command: |-
                      # Install JQ
                      yum -y install jq

                      # Get the ARN of the load balancer
                      load_balancer_arn=$(aws elbv2 describe-load-balancers \
                        --names "$load_balancer_name" \
                        --query "LoadBalancers[0].LoadBalancerArn" \
                        --output text)

                      # Print the ARN of the load balancer
                      echo "Load balancer ARN: $load_balancer_arn"

                      # Blue TG
                      blue_tg=""

                      # Green TG
                      green_tg=""

                      # Blue Unique tg when single
                      last_blue_tg=""

                      # Green Unique tg when single
                      last_green_tg=""

                      listener_blue_arn=""
                      listener_green_arn=""
                      blue_tg_arn=""
                      green_tg_arn=""


                      # json=$(aws elbv2 describe-listeners --load-balancer-arn $load_balancer_arn | jq -r '.Listeners[] | [.ListenerArn, .Port, .DefaultActions[].TargetGroupArn] | @json')


                      json=$(aws elbv2 describe-listeners --load-balancer-arn $load_balancer_arn | jq -r '.Listeners[] | [{listenerArn: .ListenerArn, port: .Port, targetGroupArn: .DefaultActions[].TargetGroupArn}] | @json')

                      # Iterate over the array
                      #echo $json
                      for row in $(echo "${json}" | jq -c '.[]'); do
                        #echo $row
                        listener_arn=$(echo "${row}" | jq -r '.listenerArn')
                        port=$(echo "${row}" | jq -r '.port')
                        tg_arn=$(echo "${row}" | jq -r '.targetGroupArn')

                        echo "Listener ARN: $listener_arn, Port: $port, Target Group ARN: $tg_arn"

                        if [ "$port" -eq 80 ]; then
                          listener_blue_arn="$listener_arn"
                          blue_tg_arn="$tg_arn"
                          echo "Found blue Listener and TG: $blue_tg_arn"
                        elif [ "$port" -eq 81 ]; then
                          listener_green_arn="$listener_arn"
                          green_tg_arn="$tg_arn"
                          echo "Found Green Listener and TG: $green_tg_arn"
                        fi
                      done

                      echo "Blue listener ARN: ${listener_blue_arn}"
                      echo "Blue target group ARN: ${blue_tg_arn}"
                      echo "Green listener ARN: ${listener_green_arn}"
                      echo "Green target group ARN: ${green_tg_arn}"

                      # Function to get listener details
                      function get_listener_json {
                          local listener_arn=$1
                          aws elbv2 describe-listeners --listener-arn "$listener_arn"
                      }

                      # Function to get target group color
                      function get_target_group_color {
                          local tg_arn=$1
                          aws elbv2 describe-tags --resource-arns "$tg_arn" --query 'TagDescriptions[].Tags[?Key==`color`].Value' --output text
                      }

                      # Function to reconfigure listener
                      function reconfigure_listener {
                          local listener_arn=$1
                          local tg_arn=$2
                          local tg_color=$3

                          if [ -z "$tg_color" ]; then
                              echo "Tag \"color\" not found!"
                              echo "As I found more than 1 TG, please add a tag called color and set value as $tg_color in the $tg_color TG tags"
                              exit 10
                          else
                              echo "Tag \"color\" found!"
                          fi

                          echo "Reconfiguring listener to use only the $tg_color TG"
                          json=$(jq -n \
                          --arg tg_arn "$tg_arn" \
                          '{ 
                              Type: "forward",
                              Order: 1,
                              ForwardConfig: {
                                  TargetGroups: [
                                  { TargetGroupArn: $tg_arn, Weight: 1 }
                                  ],
                                  TargetGroupStickinessConfig: {
                                  Enabled: true,
                                  DurationSeconds: 10
                                  }
                              }
                          }')

                          aws elbv2 modify-listener \
                          --listener-arn "$listener_arn" \
                          --default-actions "$json" --output text
                      }



                      # Get Blue listener details
                      listener_blue_json=$(get_listener_json "$listener_blue_arn")

                      # Get Green listener details
                      listener_green_json=$(get_listener_json "$listener_green_arn")

                      # Extract Blue listener's target groups from JSON output
                      tg_blue_groups=$(echo "$listener_blue_json" | jq -r '.Listeners[].DefaultActions[] | select(.Type == "forward") | .ForwardConfig.TargetGroups[]')
                      tg_green_groups=$(echo "$listener_green_json" | jq -r '.Listeners[].DefaultActions[] | select(.Type == "forward") | .ForwardConfig.TargetGroups[]')

                      # Initialize variables to store target group count and ARNs
                      tg_blue_count=0
                      tg_green_count=0
                      tg_blue_arns=()
                      tg_green_arns=()

                      # Loop over Blue's target groups actions
                      for tg in $(echo "${tg_blue_groups}" | jq -r '.TargetGroupArn'); do
                        # check tg color tag
                      #   color=$(get_target_group_color "$tg")
                      #   if [ "$color" == "blue" ]; then
                      #     echo "Target group ${tg} has the color blue"
                      #     blue_tg=$tg
                      #   elif [ "$color" == "green" ]; then
                      #     echo "Target group ${tg} has the color green"
                      #   elif [ -z "$color" ]; then
                      #     echo "Target group ${tg} does not have a color tag"
                      #   else
                      #     echo "Target group ${tg} has a color tag with an unexpected value: ${color}"
                      #   fi
                        # Increment the target group count
                        ((tg_blue_count++))
                        # Add the target group ARN to the array
                        tg_blue_arns+=("$tg")
                      done

                      # Loop over Green's target groups actions
                      for tg in $(echo "${tg_green_groups}" | jq -r '.TargetGroupArn'); do
                        # check tg color tag
                      #   color=$(get_target_group_color "$tg")
                      #   if [ "$color" == "blue" ]; then
                      #     echo "Target group ${tg} has the color blue"
                      #     blue_tg=$tg
                      #   elif [ "$color" == "green" ]; then
                      #     echo "Target group ${tg} has the color green"
                      #     green_tg=$tg
                      #   elif [ -z "$color" ]; then
                      #     echo "Target group ${tg} does not have a color tag"
                      #   else
                      #     echo "Target group ${tg} has a color tag with an unexpected value: ${color}"
                      #   fi
                        # Increment the target group count
                        ((tg_green_count++))
                        # Add the target group ARN to the array
                        tg_green_arns+=("$tg")
                      done

                      if [ "$tg_blue_count" -gt 1 ]; then
                        echo "There is more than one target group in this listener, reconfiguring it to use blue tg color based on tag key color"
                        reconfigure_listener "$listener_arn" "$blue_tg" "blue"
                      else
                        echo "Found 1 TG, skipping reconfig"
                        if [ "$blue_tg" == "" ]; then
                          #echo "Tag \"color\" not found!"
                          echo "Adding tag \"color\" with \"blue\" value"
                          aws elbv2 add-tags --resource-arns "${tg}" --tags Key=color,Value=blue --output text
                          blue_tg=$last_blue_tg
                        else
                          echo "Tag \"color\" found!"
                        fi
                      fi

                      if [ "$tg_green_count" -gt 1 ]; then
                        echo "There is more than one target group in this listener, reconfiguring it to use green tg color based on tag key color"
                        reconfigure_listener "$listener_arn" "$green_tg" "green"
                      else
                        echo "Found 1 TG, skipping reconfig"
                        if [ "$green_tg" == "" ]; then
                          #echo "Tag \"color\" not found!"
                          echo "Adding tag \"color\" with \"green\" value"
                          aws elbv2 add-tags --resource-arns "${tg}" --tags Key=color,Value=green --output text
                          green_tg=$last_green_tg
                        else
                          echo "Tag \"color\" found!"
                        fi
                      fi

                      # Print the target group count and ARNs
                      echo "Blue Target Group Count: $tg_blue_count"
                      echo "Blue Target Group ARNs: ${tg_blue_arns[@]}"
                      echo "------------------------------------------------"
                      echo "Green Target Group Count: $tg_blue_count"
                      echo "Green Target Group ARNs: ${tg_blue_arns[@]}"

                      export listener_blue_arn=$listener_blue_arn
                      export blue_tg=$blue_tg_arn
                      export green_tg=$green_tg_arn
                    shell: Bash
                    infrastructure:
                      type: KubernetesDirect
                      spec:
                        connectorRef: account.cddemose
                        namespace: dev
                        resources:
                          limits:
                            cpu: "0.5"
                            memory: 500Mi
                    outputVariables:
                      - name: listener_blue_arn
                      - name: blue_tg
                      - name: green_tg
                    envVariables:
                      AWS_ACCESS_KEY_ID: <+secrets.getValue("AWS_ACCESS_KEY_ID")>
                      AWS_SECRET_ACCESS_KEY: <+secrets.getValue("AWS_SECRET_ACCESS_KEY")>
                      load_balancer_name: <+input>
                      AWS_REGION: us-east-2
                  timeout: 10m
              - stepGroup:
                  name: Canary
                  identifier: Canary
                  steps:
                    - step:
                        type: EcsCanaryDeploy
                        name: Ecs Canary Deploy
                        identifier: Ecs_Canary_Deploy
                        spec: {}
                        timeout: 10m
                    - step:
                        type: HarnessApproval
                        name: Approval
                        identifier: Approval
                        spec:
                          approvalMessage: Please review the following information and approve the pipeline progression
                          includePipelineExecutionHistory: true
                          approvers:
                            userGroups:
                              - account._account_all_users
                            minimumCount: 1
                            disallowPipelineExecutor: false
                          approverInputs: []
                        timeout: 15m
                        failureStrategies:
                          - onFailure:
                              errors:
                                - Timeout
                              action:
                                type: MarkAsSuccess
                    - step:
                        type: EcsCanaryDelete
                        name: Ecs Canary Delete
                        identifier: Ecs_Canary_Delete
                        spec: {}
                        timeout: 10m
                  when:
                    stageStatus: Success
                    condition: <+pipeline.variables.deployment_type> == "canary"
                  failureStrategies: []
                  spec: {}
              - parallel:
                  - stepGroup:
                      name: Blue Green Deployment
                      identifier: blueGreenDepoyment
                      steps:
                        - step:
                            name: ECS Blue Green Create Service
                            identifier: EcsBlueGreenCreateService
                            type: EcsBlueGreenCreateService
                            timeout: 10m
                            spec:
                              loadBalancer: banking-app
                              prodListener: arn:aws:elasticloadbalancing:us-east-2:759984737373:listener/app/banking-app/ef5aec92b6e26fa6/b9306c7d6389fc55
                              prodListenerRuleArn: arn:aws:elasticloadbalancing:us-east-2:759984737373:listener-rule/app/banking-app/ef5aec92b6e26fa6/b9306c7d6389fc55/77a9842d37186e22
                              stageListener: arn:aws:elasticloadbalancing:us-east-2:759984737373:listener/app/banking-app/ef5aec92b6e26fa6/708fe928a86d4196
                              stageListenerRuleArn: arn:aws:elasticloadbalancing:us-east-2:759984737373:listener-rule/app/banking-app/ef5aec92b6e26fa6/708fe928a86d4196/5df2c2cebcd1e052
                        - step:
                            type: HarnessApproval
                            name: Shift Traffic - Green 10 - Approval
                            identifier: Shift_Traffic_Blue_90_Green_10_Approval
                            spec:
                              approvalMessage: Please review the following information and approve the pipeline progression
                              includePipelineExecutionHistory: true
                              approvers:
                                userGroups:
                                  - account._account_all_users
                                minimumCount: 1
                                disallowPipelineExecutor: false
                              approverInputs: []
                            timeout: 1d
                            when:
                              stageStatus: Success
                              condition: <+pipeline.variables.blue_green_gradually> == "yes"
                            failureStrategies: []
                        - step:
                            type: ShellScript
                            name: Shift Traffic - Blue 90 - Green 10
                            identifier: Shift_Traffic_Blue_90_Green_10
                            spec:
                              shell: Bash
                              onDelegate: true
                              source:
                                type: Inline
                                spec:
                                  script: |-

                                    #!/bin/bash

                                    # blue_weight=90
                                    # green_weight=10

                                    if [ -n "$blue_listener_arn" ] && [ -n "$blue_tg_arn" ] && [ -n "$green_tg_arn" ]; then
                                      echo "Adding Green TG to Blue Listener..."
                                      echo "Shifting $green_weight% of traffic distribution to Green TG"
                                      echo "--------------------------------"
                                      # Construct the JSON object with dynamic values
                                      json=$(jq -n \
                                        --arg tg_arn_blue "$blue_tg_arn" \
                                        --arg tg_arn_blue_weight "$blue_weight" \
                                        --arg tg_arn_green "$green_tg_arn" \
                                        --arg tg_arn_green_weight "$green_weight" \
                                        '{ 
                                          Type: "forward",
                                          Order: 1,
                                          ForwardConfig: {
                                            TargetGroups: [
                                              { TargetGroupArn: $tg_arn_blue, Weight: $tg_arn_blue_weight },
                                              { TargetGroupArn: $tg_arn_green, Weight: $tg_arn_green_weight }
                                            ],
                                            TargetGroupStickinessConfig: {
                                              Enabled: true,
                                              DurationSeconds: 10
                                            }
                                          }
                                        }')

                                      # Pass the JSON string to the modify-listener command
                                      aws elbv2 modify-listener \
                                        --listener-arn "$blue_listener_arn" \
                                        --default-actions "$json" --output text
                                      echo "Trafic Shifted Gradually - Blue: - Green: "
                                    else
                                      echo "Blue Listener or Green TG not found"
                                      exit 1
                                    fi
                              environmentVariables:
                                - name: blue_tg_arn
                                  type: String
                                  value: <+execution.steps.blueGreenDepoyment.steps.Color_Check.output.outputVariables.blue_tg>
                                - name: blue_weight
                                  type: String
                                  value: "90"
                                - name: green_tg_arn
                                  type: String
                                  value: <+execution.steps.blueGreenDepoyment.steps.Color_Check.output.outputVariables.green_tg>
                                - name: green_weight
                                  type: String
                                  value: "10"
                                - name: blue_listener_arn
                                  type: String
                                  value: <+execution.steps.blueGreenDepoyment.steps.Color_Check.output.outputVariables.listener_blue_arn>
                              outputVariables: []
                            timeout: 10m
                            when:
                              stageStatus: Success
                              condition: <+pipeline.variables.blue_green_gradually> == "yes"
                            failureStrategies: []
                        - step:
                            type: HarnessApproval
                            name: Shift Traffic - Green 50 - Approval
                            identifier: Shift_Traffic_Green_50_Approval
                            spec:
                              approvalMessage: Please review the following information and approve the pipeline progression
                              includePipelineExecutionHistory: true
                              approvers:
                                userGroups:
                                  - account._account_all_users
                                minimumCount: 1
                                disallowPipelineExecutor: false
                              approverInputs: []
                            timeout: 1d
                            when:
                              stageStatus: Success
                              condition: <+pipeline.variables.blue_green_gradually> == "yes"
                            failureStrategies: []
                        - step:
                            type: ShellScript
                            name: Shift Traffic - Blue 50 - Green 50
                            identifier: Shift_Traffic_Blue_50_Green_50
                            spec:
                              shell: Bash
                              onDelegate: true
                              source:
                                type: Inline
                                spec:
                                  script: |-

                                    #!/bin/bash

                                    # blue_weight=90
                                    # green_weight=10

                                    if [ -n "$blue_listener_arn" ] && [ -n "$blue_tg_arn" ] && [ -n "$green_tg_arn" ]; then
                                      echo "Adding Green TG to Blue Listener..."
                                      echo "Shifting $green_weight% of traffic distribution to Green TG"
                                      echo "--------------------------------"
                                      # Construct the JSON object with dynamic values
                                      json=$(jq -n \
                                        --arg tg_arn_blue "$blue_tg_arn" \
                                        --arg tg_arn_blue_weight "$blue_weight" \
                                        --arg tg_arn_green "$green_tg_arn" \
                                        --arg tg_arn_green_weight "$green_weight" \
                                        '{ 
                                          Type: "forward",
                                          Order: 1,
                                          ForwardConfig: {
                                            TargetGroups: [
                                              { TargetGroupArn: $tg_arn_blue, Weight: $tg_arn_blue_weight },
                                              { TargetGroupArn: $tg_arn_green, Weight: $tg_arn_green_weight }
                                            ],
                                            TargetGroupStickinessConfig: {
                                              Enabled: true,
                                              DurationSeconds: 10
                                            }
                                          }
                                        }')

                                      # Pass the JSON string to the modify-listener command
                                      aws elbv2 modify-listener \
                                        --listener-arn "$blue_listener_arn" \
                                        --default-actions "$json" --output text
                                      echo "Trafic Shifted Gradually - Blue: - Green: "
                                    else
                                      echo "Blue Listener or Green TG not found"
                                      exit 1
                                    fi
                              environmentVariables:
                                - name: blue_tg_arn
                                  type: String
                                  value: <+execution.steps.blueGreenDepoyment.steps.Color_Check.output.outputVariables.blue_tg>
                                - name: blue_weight
                                  type: String
                                  value: "50"
                                - name: green_tg_arn
                                  type: String
                                  value: <+execution.steps.blueGreenDepoyment.steps.Color_Check.output.outputVariables.green_tg>
                                - name: green_weight
                                  type: String
                                  value: "50"
                                - name: blue_listener_arn
                                  type: String
                                  value: <+execution.steps.blueGreenDepoyment.steps.Color_Check.output.outputVariables.listener_blue_arn>
                              outputVariables: []
                            timeout: 10m
                            when:
                              stageStatus: Success
                              condition: <+pipeline.variables.blue_green_gradually> == "yes"
                            failureStrategies: []
                        - step:
                            type: HarnessApproval
                            name: Green SWAP Approval
                            identifier: Green_Approval
                            spec:
                              approvalMessage: Please review the following information and approve the pipeline progression
                              includePipelineExecutionHistory: true
                              approvers:
                                userGroups:
                                  - account._account_all_users
                                minimumCount: 1
                                disallowPipelineExecutor: false
                              approverInputs: []
                            timeout: 1d
                        - step:
                            name: ECS Blue Green Swap Target Groups
                            identifier: EcsBlueGreenSwapTargetGroups
                            type: EcsBlueGreenSwapTargetGroups
                            timeout: 10m
                            spec: {}
                        - step:
                            name: Post Color Check
                            identifier: Post_Color_Check
                            template:
                              templateRef: ECS_ALB_Color_Check
                              templateInputs:
                                type: ShellScript
                                spec:
                                  environmentVariables:
                                    - name: load_balancer_name
                                      type: String
                                      value: banking-app
                      when:
                        stageStatus: Success
                        condition: <+pipeline.variables.deployment_type> == "bluegreen"
                      failureStrategies: []
                      spec: {}
                  - stepGroup:
                      name: Rolling
                      identifier: Rolling
                      steps:
                        - step:
                            type: EcsRollingDeploy
                            name: Ecs Rolling Deploy
                            identifier: Ecs_Rolling_Deploy
                            spec:
                              sameAsAlreadyRunningInstances: false
                              forceNewDeployment: true
                            timeout: 10m
                      when:
                        stageStatus: Success
                        condition: <+pipeline.variables.deployment_type> == "rolling" || <+pipeline.variables.deployment_type> == "canary"
                      failureStrategies: []
                      spec: {}
            rollbackSteps:
              - step:
                  type: EcsCanaryDelete
                  name: Ecs Canary Delete Rollback
                  identifier: Ecs_Canary_Delete_Rollback
                  spec: {}
                  timeout: 10m
              - step:
                  name: ECS Blue Green Rollback
                  identifier: EcsBlueGreenRollback
                  type: EcsBlueGreenRollback
                  timeout: 10m
                  spec: {}
              - step:
                  type: EcsBlueGreenRollback
                  name: Ecs Blue Green Rollback
                  identifier: Ecs_Blue_Green_Rollback
                  spec: {}
                  timeout: 10m
        tags: {}
        failureStrategies:
          - onFailure:
              errors:
                - AllErrors
              action:
                type: StageRollback
  variables:
    - name: tag
      type: String
      description: ""
      value: ecs
    - name: deployment_type
      type: String
      default: rolling
      description: ""
      value: <+input>.allowedValues(rolling,canary,bluegreen)
    - name: blue_green_gradually
      type: String
      default: "no"
      description: ""
      value: <+input>.allowedValues(yes,no)
