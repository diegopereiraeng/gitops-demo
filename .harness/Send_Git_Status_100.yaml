template:
  name: Send Git Status
  type: Step
  projectIdentifier: GIT_FLOW_DEMO
  orgIdentifier: default
  spec:
    type: Run
    spec:
      connectorRef: account.DockerHubDiego
      image: curlimages/curl:7.82.0
      shell: Sh
      command: |-
        echo "Sonar Result: <+execution.steps.Sonar_Scan_Vulnerabilities.status>"
        echo "Sonar QG Result: <+execution.steps.Sonar_Scan.status>"
        echo "Snyk Result: <+execution.steps.snyk.status>"
        echo "Bandit Result: <+execution.steps.bandit.status>"

        if [[ "<+execution.steps.Sonar_Scan.status>" == "SUCCEEDED" ]]; then
        curl -i -u diegopereiraeng:<+secrets.getValue("account.diegogittoken")> \
          -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/diegopereiraeng/payments-validation/statuses/<+codebase.commitSha> \
          -d '{"state":"success","target_url":"http://sonar.harness-demo.site/dashboard?id=payments-validation","description":"sonarqube scan passed","context":"harness-ci/sonarqube"}'
        else
        curl -i -u diegopereiraeng:<+secrets.getValue("account.diegogittoken")> \
          -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/diegopereiraeng/payments-validation/statuses/<+codebase.commitSha> \
          -d '{"state":"failure","target_url":"http://sonar.harness-demo.site/dashboard?id=payments-validation","description":"sonarqube scan failed","context":"harness-ci/sonarqube"}'
        fi


        curl -i -u diegopereiraeng:<+secrets.getValue("account.diegogittoken")> \
          -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/diegopereiraeng/payments-validation/statuses/<+codebase.commitSha> \
          -d '{"state":"success","target_url":"https://app.snyk.io/","description":"snyk scan passed","context":"harness-ci/snyk"}'


        curl -i -u diegopereiraeng:<+secrets.getValue("account.diegogittoken")> \
          -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/diegopereiraeng/payments-validation/statuses/<+codebase.commitSha> \
          -d '{"state":"success","target_url":"https://bandit.readthedocs.io/","description":"bandit scan passed","context":"harness-ci/bandit"}'

          
      imagePullPolicy: IfNotPresent
    when:
      stageStatus: Success
      condition: <+codebase.build.type>=="PR"
  identifier: Send_Git_Status
  versionLabel: 1.0.0
